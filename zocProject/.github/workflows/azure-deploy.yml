name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
        tools: composer:v2
        coverage: none

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Get Composer Cache Directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-interaction --no-dev --optimize-autoloader

    - name: Install NPM dependencies
      run: npm ci

    - name: Build frontend assets
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deployment
        rsync -av --exclude='node_modules' \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='tests' \
          --exclude='storage/logs/*' \
          --exclude='storage/framework/cache/*' \
          --exclude='storage/framework/sessions/*' \
          --exclude='storage/framework/views/*' \
          --exclude='.env' \
          --exclude='.env.example' \
          --exclude='phpunit.xml' \
          --exclude='README.md' \
          . deployment/

    - name: Create required directories
      run: |
        cd deployment
        mkdir -p storage/framework/cache
        mkdir -p storage/framework/sessions
        mkdir -p storage/framework/views
        mkdir -p storage/logs
        mkdir -p bootstrap/cache
        chmod -R 775 storage bootstrap/cache

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./deployment

    - name: Run post-deployment commands
      uses: azure/CLI@v2
      with:
        inlineScript: |
          az webapp config appsettings set \
            --name ${{ secrets.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings \
              APP_ENV=production \
              APP_DEBUG=false \
              APP_KEY="${{ secrets.APP_KEY }}" \
              DB_CONNECTION=mysql \
              DB_HOST="${{ secrets.DB_HOST }}" \
              DB_PORT="${{ secrets.DB_PORT }}" \
              DB_DATABASE="${{ secrets.DB_DATABASE }}" \
              DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          
          az webapp ssh --name ${{ secrets.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --command "cd /home/site/wwwroot && php artisan migrate --force && php artisan config:cache && php artisan route:cache && php artisan view:cache"
